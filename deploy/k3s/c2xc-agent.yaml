apiVersion: v1
kind: Namespace
metadata:
  name: c2xc
---
apiVersion: v1
kind: Secret
metadata:
  name: c2xc-secrets
  namespace: c2xc
type: Opaque
stringData:
  # TODO: Replace with your real keys.
  OPENAI_API_KEY: "__REPLACE_OPENAI_API_KEY__"
  C2XC_EMBEDDING_API_KEY: "__REPLACE_C2XC_EMBEDDING_API_KEY__"
---
apiVersion: v1
kind: Service
metadata:
  name: c2xc-backend
  namespace: c2xc
spec:
  type: ClusterIP
  selector:
    app: c2xc-backend
  ports:
    - name: http
      port: 8000
      targetPort: 8000
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: c2xc-backend
  namespace: c2xc
spec:
  serviceName: c2xc-backend
  replicas: 1
  selector:
    matchLabels:
      app: c2xc-backend
  template:
    metadata:
      labels:
        app: c2xc-backend
    spec:
      # Single-tenant/single-instance assumption: pin to one node that has the hostPath data + KB.
      # TODO: Replace with a real k3s node name (see `kubectl get nodes -o wide`).
      nodeName: "__REPLACE_NODE_NAME__"

      terminationGracePeriodSeconds: 30

      initContainers:
        - name: init-data-dir
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              set -eu
              mkdir -p /app/data
              mkdir -p /app/data/chroma
              chown -R 10001:10001 /app/data
          securityContext:
            runAsUser: 0
            runAsGroup: 0
          volumeMounts:
            - name: c2xc-data
              mountPath: /app/data

      containers:
        - name: backend
          image: c2xc-agent-backend:__TAG__
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8000
          env:
            # --- Service behavior
            - name: C2XC_ENABLE_WORKER
              value: "1"
            - name: C2XC_RECONCILE_ON_STARTUP
              value: "1"
            - name: C2XC_ENABLE_DEBUG_ENDPOINTS
              value: "0"
            - name: C2XC_LOG_LEVEL
              value: "info"

            # --- Storage (hostPath)
            - name: C2XC_SQLITE_PATH
              value: "/app/data/app.db"
            - name: C2XC_RB_CHROMA_DIR
              value: "/app/data/chroma"

            # --- Knowledge Bases (hostPath)
            - name: LIGHTRAG_KB_PRINCIPLES_DIR
              value: "/app/kb/kb_principles"
            - name: LIGHTRAG_KB_MODULATION_DIR
              value: "/app/kb/kb_modulation"

            # --- LLM (OpenAI-compatible)
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: c2xc-secrets
                  key: OPENAI_API_KEY
            - name: OPENAI_API_BASE
              value: "__REPLACE_OPENAI_API_BASE__"
            - name: LLM_MODEL
              value: "__REPLACE_LLM_MODEL__"
            # Optional (provider-specific): enable hybrid-thinking for Qwen via compatible gateways.
            - name: C2XC_LLM_ENABLE_THINKING
              value: "0"

            # --- Embeddings (OpenAI-compatible; can differ from chat gateway)
            - name: C2XC_EMBEDDING_API_BASE
              value: "__REPLACE_C2XC_EMBEDDING_API_BASE__"
            - name: C2XC_EMBEDDING_API_KEY
              valueFrom:
                secretKeyRef:
                  name: c2xc-secrets
                  key: C2XC_EMBEDDING_API_KEY
            - name: C2XC_EMBEDDING_MODEL
              value: "__REPLACE_C2XC_EMBEDDING_MODEL__"
            - name: C2XC_EMBEDDING_DIM
              value: "__REPLACE_C2XC_EMBEDDING_DIM__"
            # Only some providers support `dimensions`; keep off by default.
            - name: C2XC_EMBEDDING_SEND_DIMENSIONS
              value: "0"

            # --- ReasoningBank
            - name: C2XC_RB_EMBEDDING_MODE
              value: "openai"
            # Optional: different model/base for RB learn (extract/merge).
            - name: C2XC_RB_LEARN_LLM_MODEL
              value: "__REPLACE_C2XC_RB_LEARN_LLM_MODEL__"
            - name: C2XC_RB_LEARN_OPENAI_API_BASE
              value: "__REPLACE_C2XC_RB_LEARN_OPENAI_API_BASE__"
            # Optional: allow RB learn to run without LLM (offline testing).
            - name: C2XC_RB_LEARN_DRY_RUN
              value: "0"

            # --- CORS (only needed if frontend is on a different origin)
            - name: C2XC_CORS_ORIGINS
              value: "https://__REPLACE_DOMAIN__"
            # Some libraries write caches/temp files; keep them off the container root fs.
            - name: TMPDIR
              value: "/tmp"
            - name: XDG_CACHE_HOME
              value: "/tmp/.cache"

          volumeMounts:
            - name: c2xc-data
              mountPath: /app/data
            - name: tmp
              mountPath: /tmp
            - name: c2xc-kb-principles
              mountPath: /app/kb/kb_principles
              readOnly: true
            - name: c2xc-kb-modulation
              mountPath: /app/kb/kb_modulation
              readOnly: true

          readinessProbe:
            httpGet:
              path: /api/v1/healthz
              port: 8000
            initialDelaySeconds: 3
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 12
          livenessProbe:
            httpGet:
              path: /api/v1/healthz
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6

          resources:
            requests:
              cpu: "1000m"
              memory: "2Gi"
            limits:
              cpu: "4000m"
              memory: "8Gi"

          securityContext:
            runAsNonRoot: true
            runAsUser: 10001
            runAsGroup: 10001
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]

      volumes:
        - name: c2xc-data
          hostPath:
            path: /var/lib/c2xc/data
            type: DirectoryOrCreate
        - name: tmp
          emptyDir: {}
        - name: c2xc-kb-principles
          hostPath:
            path: /var/lib/c2xc/kb/kb_principles
            type: Directory
        - name: c2xc-kb-modulation
          hostPath:
            path: /var/lib/c2xc/kb/kb_modulation
            type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: c2xc-frontend
  namespace: c2xc
spec:
  type: ClusterIP
  selector:
    app: c2xc-frontend
  ports:
    - name: http
      port: 80
      targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: c2xc-frontend
  namespace: c2xc
spec:
  replicas: 1
  selector:
    matchLabels:
      app: c2xc-frontend
  template:
    metadata:
      labels:
        app: c2xc-frontend
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 101
        runAsGroup: 101
        fsGroup: 101
        fsGroupChangePolicy: OnRootMismatch
      containers:
        - name: frontend
          image: c2xc-agent-frontend:__TAG__
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
          volumeMounts:
            - name: nginx-cache
              mountPath: /var/cache/nginx
            - name: nginx-run
              mountPath: /var/run
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "1000m"
              memory: "512Mi"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
      volumes:
        - name: nginx-cache
          emptyDir: {}
        - name: nginx-run
          emptyDir: {}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: c2xc-ingress
  namespace: c2xc
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - "__REPLACE_DOMAIN__"
      secretName: "__REPLACE_TLS_SECRET__"
  rules:
    - host: "__REPLACE_DOMAIN__"
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: c2xc-backend
                port:
                  number: 8000
          - path: /
            pathType: Prefix
            backend:
              service:
                name: c2xc-frontend
                port:
                  number: 80
