apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: c2xc-agent-backend-data
  namespace: custom-app
  labels:
    app: c2xc-agent
  annotations:
    # Flux: 不因 Git 中移除/重命名而被 prune 删除
    kustomize.toolkit.fluxcd.io/prune: Disabled
    # Flux: 仅在资源不存在时创建；后续不再尝试对 PVC 做 apply（避免不可变字段报错）
    kustomize.toolkit.fluxcd.io/ssa: IfNotPresent
    # Flux: 避免因上层 Kustomization 设置 force 而触发 PVC 的 delete/recreate
    kustomize.toolkit.fluxcd.io/force: Disabled
    # Helm(Flux helm-controller): 避免 upgrade/uninstall/rollback 过程中删除 PVC
    helm.sh/resource-policy: keep
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: "longhorn"
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: Service
metadata:
  name: c2xc
  namespace: custom-app
spec:
  type: ClusterIP
  selector:
    app: c2xc-agent
  ports:
    - name: http-api
      port: 8000
      targetPort: 8000
    - name: http-web
      port: 80
      targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: c2xc-agent
  namespace: custom-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: c2xc-agent
  template:
    metadata:
      labels:
        app: c2xc-agent
    spec:
      terminationGracePeriodSeconds: 30

      # Frontend needs writable emptyDir mounts for nginx; fsGroup ensures group write.
      securityContext:
        fsGroup: 101
        fsGroupChangePolicy: OnRootMismatch

      initContainers:
        - name: init-data-dir
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              set -eu
              mkdir -p /app/data
              mkdir -p /app/data/chroma
              chown -R 10001:10001 /app/data
          securityContext:
            runAsUser: 0
            runAsGroup: 0
          volumeMounts:
            - name: c2xc-agent-backend-data
              mountPath: /app/data

      containers:
        - name: backend
          image: harbor.pic-aichem.online/sunyk/c2xc-agent-backend:v0.2.2
          imagePullPolicy: Always
          ports:
            - name: http-api
              containerPort: 8000
          env:
            # --- Service behavior
            - name: C2XC_ENABLE_WORKER
              value: "1"
            - name: C2XC_RECONCILE_ON_STARTUP
              value: "1"
            - name: C2XC_ENABLE_DEBUG_ENDPOINTS
              value: "0"
            - name: C2XC_LOG_LEVEL
              value: "info"

            # --- Storage (hostPath)
            - name: C2XC_SQLITE_PATH
              value: "/app/data/app.db"
            - name: C2XC_RB_CHROMA_DIR
              value: "/app/data/chroma"

            # --- Knowledge Bases (hostPath)
            - name: LIGHTRAG_KB_PRINCIPLES_DIR
              value: "/app/data/lightrag"
            - name: LIGHTRAG_KB_MODULATION_DIR
              value: "/app/data/lightrag"

            # --- LLM (OpenAI-compatible)
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: c2xc-agent-api-key
                  key: OPENAI_API_KEY
            - name: OPENAI_API_BASE
              value: "https://dashscope.aliyuncs.com/compatible-mode/v1"
            - name: LLM_MODEL
              value: "qwen-plus"
            # Optional (provider-specific): enable hybrid-thinking for Qwen via compatible gateways.
            - name: C2XC_LLM_ENABLE_THINKING
              value: "1"

            # --- Embeddings (OpenAI-compatible; can differ from chat gateway)
            - name: C2XC_EMBEDDING_API_BASE
              value: "https://dashscope.aliyuncs.com/compatible-mode/v1"
            - name: C2XC_EMBEDDING_API_KEY
              valueFrom:
                secretKeyRef:
                  name: c2xc-agent-api-key
                  key: C2XC_EMBEDDING_API_KEY
            - name: C2XC_EMBEDDING_MODEL
              value: "text-embedding-v4"
            - name: C2XC_EMBEDDING_DIM
              value: "2048"
            # Only some providers support `dimensions`; keep off by default.
            - name: C2XC_EMBEDDING_SEND_DIMENSIONS
              value: "1"

            # --- ReasoningBank
            #- name: C2XC_RB_EMBEDDING_MODE
            #  value: "openai"
            # Optional: different model/base for RB learn (extract/merge).
            #- name: C2XC_RB_LEARN_LLM_MODEL
            #  value: "__REPLACE_C2XC_RB_LEARN_LLM_MODEL__"
            #- name: C2XC_RB_LEARN_OPENAI_API_BASE
            #  value: "__REPLACE_C2XC_RB_LEARN_OPENAI_API_BASE__"
            # Optional: allow RB learn to run without LLM (offline testing).
            #- name: C2XC_RB_LEARN_DRY_RUN
            #  value: "0"
            # Some libraries write caches/temp files; keep them off the container root fs.
            - name: TMPDIR
              value: "/tmp"
            - name: XDG_CACHE_HOME
              value: "/tmp/.cache"

          volumeMounts:
            - name: c2xc-agent-backend-data
              mountPath: /app/data
            - name: tmp-data
              mountPath: /tmp

          readinessProbe:
            httpGet:
              path: /api/v1/healthz
              port: 8000
            initialDelaySeconds: 3
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 12
          livenessProbe:
            httpGet:
              path: /api/v1/healthz
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 6

          resources:
            requests:
              cpu: "1000m"
              memory: "2Gi"
            limits:
              cpu: "4000m"
              memory: "8Gi"

          securityContext:
            runAsNonRoot: true
            runAsUser: 10001
            runAsGroup: 10001
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]

        - name: frontend
          image: harbor.pic-aichem.online/sunyk/c2xc-agent-frontend:v0.2.2
          imagePullPolicy: Always
          ports:
            - name: http-web
              containerPort: 8080
          volumeMounts:
            - name: nginx-cache
              mountPath: /var/cache/nginx
            - name: nginx-run
              mountPath: /var/run
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "1000m"
              memory: "512Mi"
          securityContext:
            runAsNonRoot: true
            runAsUser: 101
            runAsGroup: 101
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]

      imagePullSecrets:
        - name: harbor-auth

      volumes:
        - name: c2xc-agent-backend-data
          persistentVolumeClaim:
            claimName: c2xc-agent-backend-data
        - name: nginx-cache
          emptyDir: {}
        - name: nginx-run
          emptyDir: {}
        - name: tmp-data
          emptyDir: {}
